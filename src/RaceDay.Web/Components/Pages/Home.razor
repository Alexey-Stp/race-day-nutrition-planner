@page "/"
@using RaceDay.Core
@rendermode InteractiveServer

<PageTitle>Race Day Nutrition Planner</PageTitle>

<div class="planner-container">
    <div class="header">
        <h1>🏁 Race Day Nutrition Planner</h1>
        <p class="subtitle">Calculate your personalized nutrition strategy for race day</p>
    </div>

    <div class="content">
        <div class="form-section">
            <AthleteProfileForm @bind-AthleteWeight="athleteWeight" />
            <RaceDetailsForm @bind-SportType="selectedSport" @bind-Duration="raceDuration" 
                           @bind-Temperature="temperature" @bind-RaceIntensity="selectedIntensity" />
            
            <button @onclick="CalculatePlan" class="btn btn-primary btn-lg btn-calculate">
                📊 Calculate Nutrition Plan
            </button>
        </div>

        @if (plan != null)
        {
            <div class="product-schedule-section">
                <h2>Your Product Schedule</h2>
                <p class="schedule-info">
                    Weight: @athleteWeight kg | Duration: @raceDuration hours | 
                    Estimated daily calories: @((athleteWeight * 30).ToString("F0")) kcal (used for calculation)
                </p>
                
                <div class="schedule-table-wrapper">
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th>Time (min)</th>
                                <th>Product</th>
                                <th>Brand</th>
                                <th>Type</th>
                                <th>Calories (kcal)</th>
                                <th>Carbs (g)</th>
                                <th>Sodium (mg)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in schedule)
                            {
                                <tr>
                                    <td class="time-col">@item.TimeMin</td>
                                    <td class="product-col">@item.ProductName</td>
                                    <td class="brand-col">@item.Brand</td>
                                    <td class="type-col">@item.Type</td>
                                    <td class="number-col">@item.CaloriesKcal.ToString("F0")</td>
                                    <td class="number-col">@item.CarbsG.ToString("F1")</td>
                                    <td class="number-col">@item.SodiumMg.ToString("F0")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="total-label">TOTAL</td>
                                <td class="number-col total"><strong>@scheduleTotalCalories.ToString("F0")</strong></td>
                                <td class="number-col total"><strong>@scheduleTotalCarbs.ToString("F1")</strong></td>
                                <td class="number-col total"><strong>@scheduleTotalSodium.ToString("F0")</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <ProductsEditor @bind-Gels="gels" @bind-Drinks="drinks" />
            </div>
        }

        <div class="product-browser-section">
            <h2>Browse Products</h2>
            <ProductSelector OnProductAdded="AddProductToEditor" />
        </div>

        <PlanResults Plan="plan" />
    </div>
</div>

@code {
    private double athleteWeight = 75;
    private SportType selectedSport = SportType.Triathlon;
    private double raceDuration = 2;
    private double temperature = 20;
    private IntensityLevel selectedIntensity = IntensityLevel.Moderate;
    
    private List<ProductsEditor.ProductEditor> gels = new();
    private List<ProductsEditor.ProductEditor> drinks = new();
    private RaceNutritionPlan? plan;
    
    private List<ScheduleItem> schedule = new();
    private double scheduleTotalCalories = 0;
    private double scheduleTotalCarbs = 0;
    private double scheduleTotalSodium = 0;

    private class ScheduleItem
    {
        public int TimeMin { get; set; }
        public string ProductName { get; set; } = "";
        public string Brand { get; set; } = "";
        public string Type { get; set; } = "";
        public double CaloriesKcal { get; set; }
        public double CarbsG { get; set; }
        public double SodiumMg { get; set; }
    }

    protected override void OnInitialized()
    {
        // Initialize with default products
        gels.Add(new ProductsEditor.ProductEditor { Name = "Maurten Gel 100", CarbsG = 25, SodiumMg = 100 });
        gels.Add(new ProductsEditor.ProductEditor { Name = "Gu Energy Gel", CarbsG = 22, SodiumMg = 50 });
        
        drinks.Add(new ProductsEditor.ProductEditor { Name = "Maurten Drink 500ml", CarbsG = 30, SodiumMg = 300, VolumeMl = 500 });
        drinks.Add(new ProductsEditor.ProductEditor { Name = "Isotonic Drink 500ml", CarbsG = 25, SodiumMg = 200, VolumeMl = 500 });
    }

    private void CalculatePlan()
    {
        var athlete = new AthleteProfile(athleteWeight);
        var race = new RaceProfile(selectedSport, raceDuration, temperature, selectedIntensity);
        
        var allProducts = new List<Product>();
        
        // Add gels
        foreach (var gel in gels.Where(p => !string.IsNullOrWhiteSpace(p.Name)))
        {
            allProducts.Add(new Product(gel.Name, "gel", gel.CarbsG, gel.SodiumMg));
        }
        
        // Add drinks
        foreach (var drink in drinks.Where(p => !string.IsNullOrWhiteSpace(p.Name)))
        {
            allProducts.Add(new Product(drink.Name, "drink", drink.CarbsG, drink.SodiumMg, drink.VolumeMl));
        }

        if (allProducts.Count == 0)
        {
            return;
        }

        try
        {
            plan = PlanGenerator.Generate(race, athlete, allProducts);
            BuildSchedule();
        }
        catch
        {
            // Handle error - could show error message to user
        }
    }

    private void BuildSchedule()
    {
        schedule.Clear();
        scheduleTotalCalories = 0;
        scheduleTotalCarbs = 0;
        scheduleTotalSodium = 0;

        // Get all products (both gels and drinks)
        var allProductsMap = new Dictionary<string, (string Type, double CarbsG, double SodiumMg, string Brand)>();
        
        foreach (var gel in gels.Where(p => !string.IsNullOrWhiteSpace(p.Name)))
        {
            allProductsMap[gel.Name] = ("gel", gel.CarbsG, gel.SodiumMg, gel.Brand ?? "");
        }
        
        foreach (var drink in drinks.Where(p => !string.IsNullOrWhiteSpace(p.Name)))
        {
            allProductsMap[drink.Name] = ("drink", drink.CarbsG, drink.SodiumMg, drink.Brand ?? "");
        }

        // Distribute products across time points based on race duration
        if (plan?.Schedule != null && plan.Schedule.Count > 0)
        {
            var uniqueTimes = plan.Schedule.Select(s => s.TimeMin).Distinct().OrderBy(t => t).ToList();
            
            foreach (var timeMin in uniqueTimes)
            {
                var itemsAtTime = plan.Schedule.Where(s => s.TimeMin == timeMin).ToList();
                
                foreach (var item in itemsAtTime)
                {
                    if (allProductsMap.TryGetValue(item.ProductName, out var productInfo))
                    {
                        var calories = productInfo.CarbsG * 4; // 4 kcal per gram of carbs
                        
                        schedule.Add(new ScheduleItem
                        {
                            TimeMin = timeMin,
                            ProductName = item.ProductName,
                            Brand = productInfo.Brand,
                            Type = productInfo.Type,
                            CaloriesKcal = calories,
                            CarbsG = productInfo.CarbsG,
                            SodiumMg = productInfo.SodiumMg
                        });

                        scheduleTotalCalories += calories;
                        scheduleTotalCarbs += productInfo.CarbsG;
                        scheduleTotalSodium += productInfo.SodiumMg;
                    }
                }
            }
        }
    }

    private void AddProductToEditor(ProductInfo product)
    {
        var editor = new ProductsEditor.ProductEditor
        {
            Name = product.Name,
            CarbsG = product.CarbsG,
            SodiumMg = product.SodiumMg,
            VolumeMl = product.VolumeMl,
            Brand = product.Brand
        };

        if (product.ProductType == "gel")
        {
            gels.Add(editor);
        }
        else if (product.ProductType == "drink")
        {
            drinks.Add(editor);
        }
    }
}
