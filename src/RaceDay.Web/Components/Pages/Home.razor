@page "/"
@rendermode InteractiveServer

<PageTitle>Race Day Nutrition Planner</PageTitle>

<div class="planner-container">
    <div class="header">
        <h1>🏁 Race Day Nutrition Planner</h1>
        <p class="subtitle">Calculate your personalized nutrition strategy for race day</p>
    </div>

    <div class="content">
        <div class="form-section">
            <AthleteProfileForm @bind-AthleteWeight="athleteWeight" />
            <RaceDetailsForm @bind-SportType="selectedSport" @bind-Duration="raceDuration" 
                           @bind-Temperature="temperature" @bind-RaceIntensity="selectedIntensity" />
            <ProductsEditor @bind-Gels="gels" @bind-Drinks="drinks" />
            
            <button @onclick="CalculatePlan" class="btn btn-primary btn-lg btn-calculate">
                📊 Calculate Nutrition Plan
            </button>
        </div>

        <PlanResults Plan="plan" />
    </div>
</div>

@code {
    private double athleteWeight = 75;
    private SportType selectedSport = SportType.Triathlon;
    private double raceDuration = 2;
    private double temperature = 20;
    private IntensityLevel selectedIntensity = IntensityLevel.Moderate;
    
    private List<ProductsEditor.ProductEditor> gels = new();
    private List<ProductsEditor.ProductEditor> drinks = new();
    private RaceNutritionPlan? plan;

    protected override void OnInitialized()
    {
        // Initialize with default products
        gels.Add(new ProductsEditor.ProductEditor { Name = "Maurten Gel 100", CarbsG = 25, SodiumMg = 100 });
        gels.Add(new ProductsEditor.ProductEditor { Name = "Gu Energy Gel", CarbsG = 22, SodiumMg = 50 });
        
        drinks.Add(new ProductsEditor.ProductEditor { Name = "Maurten Drink 500ml", CarbsG = 30, SodiumMg = 300, VolumeMl = 500 });
        drinks.Add(new ProductsEditor.ProductEditor { Name = "Isotonic Drink 500ml", CarbsG = 25, SodiumMg = 200, VolumeMl = 500 });
    }

    private void CalculatePlan()
    {
        var athlete = new AthleteProfile(athleteWeight);
        var race = new RaceProfile(selectedSport, raceDuration, temperature, selectedIntensity);
        
        var allProducts = new List<Product>();
        
        // Add gels
        foreach (var gel in gels.Where(p => !string.IsNullOrWhiteSpace(p.Name)))
        {
            allProducts.Add(new Product(gel.Name, "gel", gel.CarbsG, gel.SodiumMg));
        }
        
        // Add drinks
        foreach (var drink in drinks.Where(p => !string.IsNullOrWhiteSpace(p.Name)))
        {
            allProducts.Add(new Product(drink.Name, "drink", drink.CarbsG, drink.SodiumMg, drink.VolumeMl));
        }

        if (allProducts.Count == 0)
        {
            return;
        }

        try
        {
            plan = PlanGenerator.Generate(race, athlete, allProducts);
        }
        catch
        {
            // Handle error - could show error message to user
        }
    }
}
