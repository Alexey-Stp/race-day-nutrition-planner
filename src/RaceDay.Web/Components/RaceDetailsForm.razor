@using RaceDay.Core
@inject HttpClient Http

<div class="form-card">
    <h2>üèÅ Race Details</h2>
    
    <div class="form-group">
        <div class="label-with-tooltip">
            <label for="activity">Select Activity</label>
            <span class="tooltip-icon" title="Choose a predefined activity or customize your own">‚ÑπÔ∏è</span>
        </div>
        @if (activities == null)
        {
            <p class="loading">Loading activities...</p>
        }
        else
        {
            <select id="activity" @onchange="OnActivityChanged" class="form-control">
                <option value="">-- Choose an activity --</option>
                @foreach (var activity in activities)
                {
                    <option value="@activity.Id">@GetActivityEmoji(activity.SportType) @activity.Name</option>
                }
            </select>
            
            @if (selectedActivity != null)
            {
                <small class="form-text">@selectedActivity.Description</small>
                <small class="form-text"><strong>Best time:</strong> @selectedActivity.BestTimeFormatted</small>
            }
        }
    </div>

    <div class="form-group">
        <div class="label-with-tooltip">
            <label for="duration">Duration</label>
            <span class="tooltip-icon" title="Use the slider to set your race duration">‚ÑπÔ∏è</span>
        </div>
        <div class="duration-display">
            <strong>@FormatDuration(Duration)</strong>
        </div>
        <div class="slider-group">
            <input type="range" id="duration" @bind="Duration" @bind:after="OnDurationChanged" 
                   class="form-slider" min="@minDuration" max="@maxDuration" step="0.25" />
            <div class="slider-labels">
                <span>@FormatDuration(minDuration)</span>
                <span>@FormatDuration(maxDuration)</span>
            </div>
        </div>
        @if (durationValidationError != null)
        {
            <small class="form-text validation-error">‚ö†Ô∏è @durationValidationError</small>
        }
    </div>

    <div class="form-group">
        <div class="label-with-tooltip">
            <label for="temperature">Temperature</label>
            <span class="tooltip-icon" title="Affects fluid and sodium requirements. Higher temperatures increase needs.">‚ÑπÔ∏è</span>
        </div>
        <div class="input-group">
            <input type="number" id="temperature" @bind="Temperature" class="form-control" 
                   min="-10" max="40" step="1" placeholder="e.g. 20" />
            <span class="input-unit">¬∞C</span>
        </div>
    </div>

    <div class="form-group">
        <div class="label-with-tooltip">
            <label for="intensity">Intensity Level</label>
            <span class="tooltip-icon" title="Easy: Recovery pace, 60-70% max HR | Moderate: Steady pace, 70-85% max HR | Hard: Threshold/race pace, 85%+ max HR">‚ÑπÔ∏è</span>
        </div>
        <select id="intensity" @bind="RaceIntensity" class="form-control">
            <option value="@IntensityLevel.Easy">Easy - Recovery/endurance pace</option>
            <option value="@IntensityLevel.Moderate">Moderate - Steady/comfortable pace</option>
            <option value="@IntensityLevel.Hard">Hard - Threshold/race pace</option>
        </select>
        <small class="form-text">Higher intensity increases carbohydrate consumption.</small>
    </div>
</div>

@code {
    [Parameter]
    public Core.SportType SportType { get; set; } = Core.SportType.Triathlon;

    [Parameter]
    public EventCallback<Core.SportType> SportTypeChanged { get; set; }

    [Parameter]
    public double Duration { get; set; } = 2;

    [Parameter]
    public EventCallback<double> DurationChanged { get; set; }

    [Parameter]
    public double Temperature { get; set; } = 20;

    [Parameter]
    public EventCallback<double> TemperatureChanged { get; set; }

    [Parameter]
    public IntensityLevel RaceIntensity { get; set; } = IntensityLevel.Moderate;

    [Parameter]
    public EventCallback<IntensityLevel> RaceIntensityChanged { get; set; }

    private List<ActivityInfo>? activities;
    private ActivityInfo? selectedActivity;
    private double minDuration = 0.5;
    private double maxDuration = 24;
    private string? durationValidationError;

    protected override async Task OnInitializedAsync()
    {
        await LoadActivities();
    }

    private async Task LoadActivities()
    {
        try
        {
            activities = await Http.GetFromJsonAsync<List<ActivityInfo>>("http://localhost:5294/api/activities");
            
            // Set default activity to Triathlon (closest match to original default)
            var defaultActivity = activities?.FirstOrDefault(a => a.Name.Contains("Olympic"));
            if (defaultActivity != null)
            {
                selectedActivity = defaultActivity;
                SportType = defaultActivity.SportType;
                minDuration = defaultActivity.MinDurationHours;
                maxDuration = defaultActivity.MaxDurationHours;
                Duration = defaultActivity.BestTimeHours;
                await SportTypeChanged.InvokeAsync(SportType);
                await DurationChanged.InvokeAsync(Duration);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading activities: {ex.Message}");
            activities = new List<ActivityInfo>();
        }
    }

    private async Task OnActivityChanged(ChangeEventArgs e)
    {
        var activityId = e.Value?.ToString();
        if (string.IsNullOrEmpty(activityId))
        {
            selectedActivity = null;
            durationValidationError = null;
            return;
        }

        selectedActivity = activities?.FirstOrDefault(a => a.Id == activityId);
        if (selectedActivity != null)
        {
            minDuration = selectedActivity.MinDurationHours;
            maxDuration = selectedActivity.MaxDurationHours;
            Duration = selectedActivity.BestTimeHours;
            SportType = selectedActivity.SportType;
            durationValidationError = null;

            await SportTypeChanged.InvokeAsync(SportType);
            await DurationChanged.InvokeAsync(Duration);
        }
    }

    private string FormatDuration(double hours)
    {
        var wholeHours = (int)hours;
        var minutes = (int)((hours - wholeHours) * 60);
        
        if (wholeHours == 0)
        {
            return $"{minutes} minutes";
        }
        else if (minutes == 0)
        {
            return $"{wholeHours} hour{(wholeHours > 1 ? "s" : "")}";
        }
        else
        {
            return $"{wholeHours} hour{(wholeHours > 1 ? "s" : "")} {minutes} minutes";
        }
    }

    private async Task OnDurationChanged()
    {
        // Validate duration is within activity limits if activity is selected
        if (selectedActivity != null)
        {
            if (Duration < selectedActivity.MinDurationHours)
            {
                durationValidationError = $"Duration must be at least {FormatDuration(selectedActivity.MinDurationHours)}";
            }
            else if (Duration > selectedActivity.MaxDurationHours)
            {
                durationValidationError = $"Duration must not exceed {FormatDuration(selectedActivity.MaxDurationHours)}";
            }
            else
            {
                durationValidationError = null;
            }
        }

        await DurationChanged.InvokeAsync(Duration);
    }

    private string GetActivityEmoji(Core.SportType sportType) => sportType switch
    {
        Core.SportType.Run => "üèÉ",
        Core.SportType.Bike => "üö¥",
        Core.SportType.Triathlon => "üèä",
        _ => "üèÅ"
    };
}
