name: Build & Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build, Test & Quality Check

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Restore .NET dependencies
      run: dotnet restore
    
    - name: Build .NET Solution
      run: dotnet build --configuration Release --no-restore --verbosity normal
    
    - name: Run Unit Tests with Code Coverage
      run: dotnet test --configuration Release --no-build --verbosity normal --logger "console;verbosity=detailed" --collect:"XPlat Code Coverage" --results-directory ./coverage
    
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/**/coverage.cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Check Coverage Threshold & Report Low Coverage
      run: |
        COVERAGE_FILE=$(find ./coverage -name "coverage.cobertura.xml" | head -1)
        
        if [ -z "$COVERAGE_FILE" ]; then
          echo "âŒ No coverage report found!"
          exit 1
        fi
        
        # Extract overall coverage
        OVERALL_COVERAGE=$(grep -o 'line-rate="[^"]*"' "$COVERAGE_FILE" | head -1 | grep -o '[0-9]*\.[0-9]*')
        OVERALL_PERCENT=$(($(echo "$OVERALL_COVERAGE * 100" | bc -l | cut -d. -f1)))
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š CODE COVERAGE REPORT"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Show overall coverage
        if (( $(echo "$OVERALL_COVERAGE < 0.80" | bc -l) )); then
          echo "âŒ Overall Coverage: $OVERALL_PERCENT% (Target: 80%)"
        else
          echo "âœ… Overall Coverage: $OVERALL_PERCENT% (Target: 80%)"
        fi
        echo ""
        
        # Extract and show low coverage files
        echo "ğŸ“ Classes/Files with Low Coverage (< 50%):"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        grep '<class' "$COVERAGE_FILE" | while read line; do
          CLASS_NAME=$(echo "$line" | grep -o 'name="[^"]*"' | cut -d'"' -f2)
          LINE_RATE=$(echo "$line" | grep -o 'line-rate="[^"]*"' | cut -d'"' -f2)
          LINE_PERCENT=$(($(echo "$LINE_RATE * 100" | bc -l | cut -d. -f1)))
          
          if (( $(echo "$LINE_RATE < 0.50" | bc -l) )); then
            echo "  ğŸ”´ $CLASS_NAME: $LINE_PERCENT%"
          fi
        done
        
        echo ""
        echo "ğŸ“ Classes/Files with Medium Coverage (50-79%):"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        grep '<class' "$COVERAGE_FILE" | while read line; do
          CLASS_NAME=$(echo "$line" | grep -o 'name="[^"]*"' | cut -d'"' -f2)
          LINE_RATE=$(echo "$line" | grep -o 'line-rate="[^"]*"' | cut -d'"' -f2)
          LINE_PERCENT=$(($(echo "$LINE_RATE * 100" | bc -l | cut -d. -f1)))
          
          if (( $(echo "$LINE_RATE >= 0.50 && $LINE_RATE < 0.80" | bc -l) )); then
            echo "  ğŸŸ¡ $CLASS_NAME: $LINE_PERCENT%"
          fi
        done
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Fail if below threshold
        if (( $(echo "$OVERALL_COVERAGE < 0.80" | bc -l) )); then
          echo ""
          echo "âš ï¸  Coverage check FAILED - Write tests for uncovered code above"
          exit 1
        else
          echo "âœ… Coverage check PASSED"
        fi
    
    - name: Install React dependencies
      run: npm ci --ignore-scripts
      working-directory: src/RaceDay.Web.React
      continue-on-error: false
    
    - name: Build React Application
      run: npm run build
      working-directory: src/RaceDay.Web.React
      continue-on-error: false
    
    - name: Verify Code Quality
      run: dotnet build --configuration Release --no-restore /p:TreatWarningsAsErrors=true
      continue-on-error: false

  lint-check:
    runs-on: ubuntu-latest
    name: Code Analysis
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Analyze with StyleCop
      run: dotnet build --configuration Release --no-restore /p:EnforceCodeStyleInBuild=true
      continue-on-error: true

  web-lint:
    runs-on: ubuntu-latest
    name: TypeScript & React Lint
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
      working-directory: src/RaceDay.Web.React
    
    - name: TypeScript Check
      run: npx tsc --noEmit
      working-directory: src/RaceDay.Web.React
      continue-on-error: false
